{% extends "bases.html" %}
{% load static %}

{% block title %}
{% if object %}‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç{% else %}‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç{% endif %} - –ë–ª–æ–≥ NLPers.ru
{% endblock %}

{% block meny %}

{% endblock meny %}

{% block extra_css %}
{{ form.media.css }}
<style>
.form-floating label {
    color: #6c757d;
}
.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.required-field::after {
    content: " *";
    color: #dc3545;
}
#preview-content img {
    max-width: 100%;
    height: auto;
}
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="text-center mb-5">
                <h1 class="display-5">
                    {% if object %}
                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç
                    {% else %}
                        ‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ—Å—Ç
                    {% endif %}
                </h1>
                <p class="text-muted">{{ object.title|default:"–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ —Å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ–º!" }}</p>
            </div>
            
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">üìù –†–µ–¥–∞–∫—Ç–æ—Ä –ø–æ—Å—Ç–∞</h4>
                </div>
                
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="post-form">
                        {% csrf_token %}
                        
                        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="row mb-4">
                            <div class="col-lg-8">
                                <div class="form-floating mb-3">
                                    {{ form.title }}
                                    <label for="{{ form.title.id_for_label }}" class="required-field">
                                        {{ form.title.label }}
                                    </label>
                                    {% if form.title.errors %}
                                        <div class="text-danger small mt-1">{{ form.title.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <div class="form-floating mb-3">
                                    {{ form.category }}
                                    <label for="{{ form.category.id_for_label }}">
                                        üìÅ {{ form.category.label }}
                                    </label>
                                    {% if form.category.errors %}
                                        <div class="text-danger small mt-1">{{ form.category.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ -->
                        <div class="mb-4">
                            <label for="{{ form.excerpt.id_for_label }}" class="form-label">
                                <strong>üìù {{ form.excerpt.label }}</strong>
                            </label>
                            {{ form.excerpt }}
                            <div class="form-text">{{ form.excerpt.help_text }}</div>
                            <div id="excerpt-counter" class="text-muted small mt-1"></div>
                            {% if form.excerpt.errors %}
                                <div class="text-danger small">{{ form.excerpt.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ -->
                        <div class="mb-4">
                            <label for="{{ form.content.id_for_label }}" class="form-label required-field">
                                <strong>üì∞ {{ form.content.label }}</strong>
                            </label>
                            {{ form.content }}
                            {% if form.content.errors %}
                                <div class="text-danger small mt-1">{{ form.content.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.featured_image.id_for_label }}" class="form-label">
                                    <strong>üñºÔ∏è {{ form.featured_image.label }}</strong>
                                </label>
                                {{ form.featured_image }}
                                {% if object and object.featured_image %}
                                <div class="mt-2">
                                    <small class="text-muted">–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</small><br>
                                    <img src="{{ object.featured_image.url }}" alt="Current image" class="img-thumbnail" style="max-width: 200px;">
                                </div>
                                {% endif %}
                                {% if form.featured_image.errors %}
                                    <div class="text-danger small mt-1">{{ form.featured_image.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    {{ form.tags }}
                                    <label for="{{ form.tags.id_for_label }}">
                                        üè∑Ô∏è {{ form.tags.label }}
                                    </label>
                                    <div class="form-text">{{ form.tags.help_text }}</div>
                                    {% if form.tags.errors %}
                                        <div class="text-danger small">{{ form.tags.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ -->
                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <h5 class="card-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</h5>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-floating mb-3">
                                            {{ form.status }}
                                            <label for="{{ form.status.id_for_label }}" class="required-field">
                                                üìä {{ form.status.label }}
                                            </label>
                                            {% if form.status.errors %}
                                                <div class="text-danger small">{{ form.status.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="form-check mt-3">
                                            {{ form.is_featured }}
                                            <label class="form-check-label" for="{{ form.is_featured.id_for_label }}">
                                                ‚≠ê {{ form.is_featured.label }}
                                            </label>
                                            <div class="form-text">–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã—Ö –ø–æ—Å—Ç–∞—Ö</div>
                                            {% if form.is_featured.errors %}
                                                <div class="text-danger small">{{ form.is_featured.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="form-check mt-3">
                                            {{ form.allow_comments }}
                                            <label class="form-check-label" for="{{ form.allow_comments.id_for_label }}">
                                                üí¨ {{ form.allow_comments.label }}
                                            </label>
                                            {% if form.allow_comments.errors %}
                                                <div class="text-danger small">{{ form.allow_comments.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a href="{% if object %}{% url 'Blog:post_detail' object.slug %}{% else %}{% url 'Blog:index' %}{% endif %}" class="btn btn-outline-secondary">
                                    ‚ùå –û—Ç–º–µ–Ω–∞
                                </a>
                            </div>
                            
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-info" id="preview-btn">
                                    üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                                </button>
                                {% if object %}
                                <button type="submit" name="status" value="draft" class="btn btn-warning">
                                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫
                                </button>
                                <button type="submit" name="status" value="published" class="btn btn-success">
                                    üì§ –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å—Ç
                                </button>
                                {% else %}
                                <button type="submit" name="status" value="draft" class="btn btn-warning">
                                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫
                                </button>
                                <button type="submit" name="status" value="published" class="btn btn-success">
                                    üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä -->
            <div class="card" id="preview-card" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
                        <button type="button" class="btn btn-sm btn-outline-light float-end" id="close-preview">
                            ‚úñÔ∏è –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </h5>
                </div>
                <div class="card-body" id="preview-content">
                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
            
            <!-- –°–æ–≤–µ—Ç—ã –ø–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—é -->
            <div class="card mt-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üí° –°–æ–≤–µ—Ç—ã –ø–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—é —Ö–æ—Ä–æ—à–µ–≥–æ –ø–æ—Å—Ç–∞</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-2">‚úÖ <strong>–ü—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —è—Å–Ω—ã–µ –∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏</li>
                                <li class="mb-2">‚úÖ <strong>–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç:</strong> –†–∞–∑–±–∏–≤–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏</li>
                                <li class="mb-2">‚úÖ <strong>–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</strong> –î–æ–±–∞–≤—å—Ç–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–µ –≥–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li class="mb-2">‚úÖ <strong>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</strong> –ù–∞–ø–∏—à–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ–∑—é–º–µ –ø–æ—Å—Ç–∞</li>
                                <li class="mb-2">‚úÖ <strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–µ–≥–∏:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–µ–≥–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∏—Å–∫–∞</li>
                                <li class="mb-2">‚úÖ <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏–∏:</strong> –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ form.media.js }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
    const form = document.querySelector('#post-form');
    const titleField = document.querySelector('#id_title');
    const excerptField = document.querySelector('#id_excerpt');
    const contentField = document.querySelector('#id_content');
    const previewBtn = document.querySelector('#preview-btn');
    const previewCard = document.querySelector('#preview-card');
    const previewContent = document.querySelector('#preview-content');
    const closePreviewBtn = document.querySelector('#close-preview');
    
    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    let autoSaveTimer;
    let hasChanges = false;
    
    function markAsChanged() {
        hasChanges = true;
        resetAutoSaveTimer();
    }
    
    function autoSave() {
        if (hasChanges && (titleField.value.trim() || contentField.value.trim())) {
            console.log('üîÑ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞...');
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        }
    }
    
    function resetAutoSaveTimer() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(autoSave, 30000);
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    [titleField, excerptField, contentField].forEach(field => {
        if (field) {
            field.addEventListener('input', markAsChanged);
        }
    });
    
    // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è excerpt
    if (excerptField) {
        const maxLength = 300;
        const counter = document.querySelector('#excerpt-counter');
        
        function updateCounter() {
            const remaining = maxLength - excerptField.value.length;
            counter.textContent = `–°–∏–º–≤–æ–ª–æ–≤: ${excerptField.value.length}/${maxLength}`;
            
            if (remaining < 0) {
                counter.classList.add('text-danger');
                counter.classList.remove('text-muted');
            } else if (remaining < 50) {
                counter.classList.add('text-warning');
                counter.classList.remove('text-muted', 'text-danger');
            } else {
                counter.classList.add('text-muted');
                counter.classList.remove('text-danger', 'text-warning');
            }
        }
        
        excerptField.addEventListener('input', updateCounter);
        updateCounter();
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —Å—Ç–∞—Ç—É—Å–∞
    document.querySelectorAll('button[name="status"]').forEach(button => {
        button.addEventListener('click', function(e) {
            const statusSelect = document.querySelector('#id_status');
            if (statusSelect) {
                statusSelect.value = this.value;
            }
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–≥–æ–≤
    const tagsField = document.querySelector('#id_tags');
    if (tagsField) {
        tagsField.addEventListener('blur', function() {
            // –û—á–∏—Å—Ç–∫–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–≥–æ–≤
            const tags = this.value.split(',').map(tag => tag.trim()).filter(tag => tag);
            this.value = tags.join(', ');
        });
    }
    
    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            const title = titleField.value;
            const content = contentField.value;
            const excerpt = excerptField.value;
            
            if (!title && !content) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            let previewHTML = '';
            if (title) {
                previewHTML += `<h1 class="mb-3">${title}</h1>`;
            }
            if (excerpt) {
                previewHTML += `<p class="lead text-muted mb-4">${excerpt}</p>`;
            }
            if (content) {
                previewHTML += `<div class="post-content">${content}</div>`;
            }
            
            previewContent.innerHTML = previewHTML;
            previewCard.style.display = 'block';
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä—É
            previewCard.scrollIntoView({ behavior: 'smooth' });
        });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    if (closePreviewBtn) {
        closePreviewBtn.addEventListener('click', function() {
            previewCard.style.display = 'none';
        });
    }
    
    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
    window.addEventListener('beforeunload', function(e) {
        if (hasChanges) {
            e.preventDefault();
            e.returnValue = '';
            return '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
        }
    });
    
    // –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', function() {
        hasChanges = false;
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
    if (titleField.value || contentField.value) {
        console.log('üíæ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ. –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥.');
    }
});
</script>
{% endblock %}